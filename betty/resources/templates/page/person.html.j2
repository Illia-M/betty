{% extends 'base.html.j2' %}
{% import 'macro/person.html.j2' as personMacros %}
{% set title = personMacros.label(person, person) %}
{% block content %}
    {% include 'person-meta.html.j2' %}

    {% set places = person.presences | map(attribute='event.place') | reject('equalto', None) | unique | list %}
    {% if places | length > 0 %}
        {% with places=places %}
            {% include 'list-place.html.j2' %}
        {% endwith %}
    {% endif %}

    {%- if 'betty.plugins.wikipedia.Wikipedia' in plugins %}
        {% with entity=person %}
            {% include 'wikipedia.html.j2' %}
        {% endwith %}
    {% endif -%}

    {% set parents = person.parents | list %}
    {% if parents | length > 0 %}
        <h2>Parents</h2>
        <ul>
            {% for parent in parents %}
                <li typeof="foaf:Person" property="rel:childOf">{{ personMacros.label(parent) }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    {% set children = person.children | list %}
    {% if children | length > 0 %}
        <h2>Children</h2>
        {% for parents, siblings in children | groupby('parents.list') %}
            <p>
                {% set _ = parents.remove(person) %}
                {% if parents | length > 0 %}
                    with {{ parents | map(otherParentLabel) | join(', ') }}:
                {% endif %}
            <ul>
                {% for child in siblings %}
                    <li typeof="foaf:Person" property="rel:parentOf">{{ personMacros.label(child) }}</li>
                {% endfor %}
            </ul>
            </p>
        {% endfor %}
    {% endif %}

    {% set siblings = person.siblings | list %}
    {% if siblings | length > 0 %}
        <h2>Siblings</h2>
        <ul>
            {% for sibling in siblings %}
                <li typeof="foaf:Person" property="rel:siblingOf">{{ personMacros.label(sibling) }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <div class="featured tree js-show" data-betty-person-id="{{ person.id }}"></div>

    {% set events = person.presences | map(attribute='event') | list %}
    {% if events | rejectattr('date', 'none') | selectattr('date.complete') | list | length > 0 %}
        <h2>Events</h2>
        {% with person_context=person %}
            {% include 'list-event.html.j2' %}
        {% endwith %}
    {% endif %}

    {% set haveFiles = [person] %}
    {% set haveFiles = haveFiles + person.citations | list %}
    {% set haveFiles = haveFiles + events %}
    {% set haveFiles = haveFiles + events | map(attribute='citations') | flatten | list %}
    {% set haveFiles = haveFiles + events | map(attribute='citations') | flatten | map(attribute='source') | list %}
    {% set files = haveFiles | map(attribute='files') | flatten | unique | list %}
    {% if files | length > 0 %}
        <h2>Media</h2>
        {% include 'list-file.html.j2' %}
    {% endif %}
{% endblock %}

{% macro otherParentLabel(person) -%}
    <span typeof="foaf:Person" property="rel:spouseOf">{{ personMacros.label(person) }}</span>
{%- endmacro %}